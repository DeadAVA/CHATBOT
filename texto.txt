@app.route("/chat", methods=["POST"])
def chat():
    try:
        data = request.json
        user_message = data.get("message", "").strip().lower()
        
        if not user_message:
            return jsonify({"response": "No recib√≠ ning√∫n mensaje. üòï"})

        # Inicializar la conversaci√≥n en session si no existe
        if "messages" not in session:
            session["messages"] = []

        # -----------------------------------------------------------------------
        # 1) ¬øEstamos en proceso de llenar datos de denuncia?
        # -----------------------------------------------------------------------
        if "datos_faltantes" in session and session["datos_faltantes"]:
            datos_faltantes = session["datos_faltantes"]
            datos_usuario = session.get("datos_usuario", {})
            dato_actual = datos_faltantes[0]

            # CANCELAR (misma l√≥gica)
            if user_message.startswith("cancelar"):
                session.pop("datos_faltantes", None)
                session.pop("datos_usuario", None)
                texto = "Proceso cancelado. ¬øEn qu√© m√°s puedo ayudarte?"
                audio_response_path = text_to_speech(texto)
                return jsonify({"response": "‚ùå Proceso cancelado. ¬øEn qu√© m√°s puedo ayudarte?", "audio_response": audio_response_path})

            # OMITIR (misma l√≥gica)
            if user_message.startswith("omitir"):
                datos_usuario[dato_actual] = "_________________________"
                remaining_faltantes = datos_faltantes[1:]  # Avanzamos al siguiente dato
                
                if dato_actual == "narraciones":
                    if "narraciones" not in datos_usuario:
                        datos_usuario["narraciones"] = []

                    if not session.get("ejemplo_narraciones_mostrado", False):
                        session["ejemplo_narraciones_mostrado"] = True
                        ejemplo_narracion = (
                            "Ejemplo de narraci√≥n de hechos:\n\n"
                            "El cinco de febrero de dos mil diecisiete, estando presentes en la oficina de XXX, "
                            "ubicada en las calles de XXX, el denunciado me agredi√≥ verbalmente al se√±alar que "
                            "no deb√≠a participar como candidata al cargo de XXXX, indicando expresamente: "
                            "‚Äúustedes las mujeres no sirven para esto de la pol√≠tica, no tienen que salir de su casa "
                            "y deben quedarse en la cocina‚Äù.\n\n"
                            "Con estas expresiones, se vulneran derechos como la participaci√≥n pol√≠tica, "
                            "la no discriminaci√≥n y la vida libre de violencia.\n\n"
                            "Por favor, ingresa tu primer relato de hechos ahora. O escribe 'omitir' si no deseas narrarlo, "
                            "o 'cancelar' para salir."
                        )
                        return jsonify({"response": ejemplo_narracion})

                # Si el dato omitido es 'tipo_prueba', marcarlo y almacenar los campos dependientes
                if dato_actual == "tipo_prueba":
                    session["tipo_prueba_omitido"] = True  # Indicamos que fue omitido
                    session["campos_dependientes_tipo_prueba"] = {
                        "quien_desahoga", "numero_notarial", "notario_publico_numero",
                        "donde_funciones_notario", "fecha_intrumento_notarial",
                        "prueba_confesional", "prueba_testimonial", "documento_prueba",
                        "numeros_prueba","folio","fecha_folio", "documentos_oficiales"
                    }

                # Filtrar correctamente si `tipo_prueba` fue omitido
                if session.get("tipo_prueba_omitido", False):
                    remaining_faltantes = [
                        d for d in remaining_faltantes if d not in session["campos_dependientes_tipo_prueba"]
                    ]

                # Guardamos los cambios en la sesi√≥n
                session["datos_faltantes"] = remaining_faltantes
                session["datos_usuario"] = datos_usuario
                texto = f"Se ha omitido **{dato_actual}** autom√°ticamente porque omitiste `tipo_prueba`"
                audio_response_path = text_to_speech(texto)
                # üö® **Aqu√≠ interceptamos cada campo dependiente cuando el usuario lo intenta proporcionar**
                if dato_actual in session.get("campos_dependientes_tipo_prueba", set()):
                    return jsonify({
                        "response": markdown.markdown(f"‚úÖ Se ha omitido **{dato_actual}** autom√°ticamente porque omitiste `tipo_prueba`."),
                        "audio_response": audio_response_path
                    })

                # üöÄ **Verificar si el siguiente dato tambi√©n es un campo dependiente y omitirlo autom√°ticamente**
                while session["datos_faltantes"] and session["datos_faltantes"][0] in session.get("campos_dependientes_tipo_prueba", set()):
                    omitido = session["datos_faltantes"].pop(0)  # Eliminar el dato dependiente
                    datos_usuario[omitido] = "_________________________"

                # Verificar si hay m√°s datos faltantes despu√©s de la omisi√≥n
                if session["datos_faltantes"]:
                    siguiente_dato = session["datos_faltantes"][0]

                    # Si el siguiente dato es una medida, mostrar opciones directamente
                    if siguiente_dato == "medidas_cautelares":
                        opciones_str = "\n".join(f"{i+1}. {op}" for i, op in enumerate(MEDIDAS_CAUTELARES_OPCIONES))
                        session["pidiendo_medidas_cautelares"] = True  
                        texto = f"Se ha omitido **{dato_actual}**. Ahora, selecciona las **medidas cautelares** que solicitas para proteger tus derechos. Estas son las opciones disponibles: {opciones_str}. Para seleccionar, escribe los n√∫meros separados por comas (ej: '1,3'). Escribe 'otra' para agregar una medida no listada. Cuando termines, escribe 'terminar'."
                        audio_response_path = text_to_speech(texto)
                        return jsonify({
                            "response": markdown.markdown(
                                f"‚úÖ Se ha omitido **{dato_actual}**.\n\n"
                                "Ahora, selecciona las **medidas cautelares** que solicitas para proteger tus derechos.\n\n"
                                "Estas son las opciones disponibles:\n\n"
                                f"{opciones_str}\n\n"
                                "Para seleccionar, escribe los n√∫meros separados por comas (ej: '1,3'). "
                                "Escribe 'otra' para agregar una medida no listada. "
                                "Cuando termines, escribe 'terminar'."
                            ),
                           "audio_response": audio_response_path
                        
                        })
                    elif siguiente_dato == "medidas_proteccion":
                        opciones_str = "\n".join(f"{i+1}. {op}" for i, op in enumerate(MEDIDAS_PROTECCION_OPCIONES))
                        session["pidiendo_medidas_proteccion"] = True
                        texto = markdown.markdown(f"‚úÖ Se ha omitido **{dato_actual}**. Ahora, selecciona las **medidas de protecci√≥n** que solicitas para proteger tus derechos. Estas son las medidas de protecci√≥n disponibles: {opciones_str} Para seleccionar, escribe los n√∫meros separados por comas (ej: '1,3'). Escribe 'otra' para agregar una medida no listada. Cuando termines, escribe 'terminar'.")
                        audio_response_path = text_to_speech(texto)
                        return jsonify({
                            "response": markdown.markdown(
                                f"‚úÖ Se ha omitido **{dato_actual}**.\n\n"
                                "Ahora, selecciona las **medidas de protecci√≥n** que solicitas para proteger tus derechos.\n\n"
                                "Estas son las medidas de protecci√≥n disponibles:\n\n"
                                f"{opciones_str}\n\n"
                                "Para seleccionar, escribe los n√∫meros separados por comas (ej: '1,3'). "
                                "Escribe 'otra' para agregar una medida no listada. "
                                "Cuando termines, escribe 'terminar'."
                            ),
                            "audio_response": audio_response_path
                        })
                    
                    # Verificar si el siguiente dato es `tipo_prueba` (por seguridad)
                    elif siguiente_dato == "tipo_prueba":
                        session["ha_preguntado_tipo_prueba"] = True
                        texto = "¬øQu√© tipo de prueba deseas ofrecer? Elige una opci√≥n: 1Ô∏è.Confesional,2Ô∏è.Testimonial, 3Ô∏è.Documental P√∫blica o Privada, 4Ô∏è.Presuncional Legal y Humana, 5Ô∏è.Instrumental de Actuaciones, Escribe el n√∫mero de la opci√≥n que deseas elegir. puedes escribir para omitir o cancelar para terminar el proceso"
                        audio_response_path = text_to_speech(texto)
                        return jsonify({
                            "response": (
                                "¬øQu√© tipo de prueba deseas ofrecer? Elige una opci√≥n:\n"
                                "1Ô∏è‚É£ Confesional\n"
                                "2Ô∏è‚É£ Testimonial\n"
                                "3Ô∏è‚É£ Documental P√∫blica o Privada\n"
                                "4Ô∏è‚É£ Presuncional Legal y Humana\n"
                                "5Ô∏è‚É£ Instrumental de Actuaciones\n"
                                "Escribe el n√∫mero de la opci√≥n que deseas elegir. puedes escribir para omitir o cancelar para terminar el proceso"
                            ),
                            "audio_response": audio_response_path
                        })

                    # Preguntar por el siguiente dato normalmente
                    desc = field_info.get(siguiente_dato, {}).get("descripcion", "")
                    ejemp = field_info.get(siguiente_dato, {}).get("ejemplo", "")
                    texto = f"Se ha omitido **{dato_actual}**.Ahora, **{siguiente_dato}** es importante {desc}. {ejemp}. ¬øPodr√≠as proporcionarlo ahora? O escribe 'omitir' si no deseas darlo, o 'cancelar' para detener el proceso."
                    audio_response_path = text_to_speech(texto)
                    return jsonify({
                        "response": markdown.markdown(
                            f"‚úÖ Se ha omitido **{dato_actual}**.\n\n"
                            f"Ahora, **{siguiente_dato}** es importante {desc}.\n\n"
                            f"{ejemp}\n\n"
                            "¬øPodr√≠as proporcionarlo ahora? "
                            "O escribe 'omitir' si no deseas darlo, o 'cancelar' para detener el proceso."
                        ),
                        "audio_response": audio_response_path
                    })

                # Si no hay m√°s datos faltantes, generar la denuncia
                else:
                    try:
                        resultado = procesar_denuncia(datos_usuario)

                        # Verificamos si faltan datos obligatorios
                        if isinstance(resultado, dict) and "error" in resultado:
                            session["datos_faltantes"] = resultado["faltantes"]
                            return jsonify({
                                "response": markdown.markdown(f"‚ö†Ô∏è Faltan datos: {', '.join(resultado['faltantes'])}. Por favor, ingr√©salos para continuar.")
                            })

                        session["pdf_path"] = resultado
                        session.pop("datos_faltantes", None)
                        session.pop("datos_usuario", None)
                        session.pop("tipo_prueba_omitido", None)  # Limpiamos la sesi√≥n
                        session.pop("campos_dependientes_tipo_prueba", None)
                        texto = "La denuncia ha sido generada correctamente. Puedes descargarla en el link que te genere. Este es un formato de denuncia con los datos proporcionados. Puedes revisarlo y editarlo si lo deseas. ¬°Estoy aqu√≠ para ayudarte!"
                        audio_response_path = text_to_speech(texto)
                        return jsonify({
                            "response": (
                                "‚úÖ La denuncia ha sido generada correctamente. "
                                "Puedes descargarla aqu√≠: /download_sue\n\n"
                                "Este es un formato de denuncia con los datos proporcionados. "
                                "Puedes revisarlo y editarlo si lo deseas. ¬°Estoy aqu√≠ para ayudarte! üòä"
                            ),
                            "audio_response": audio_response_path
                        })
                    except Exception as e:
                        return jsonify({"response": f"‚ùå Error al generar la denuncia: {str(e)}"}), 500

            # -------------------------------------------------------------------
            # Manejo de preguntas/dudas y "continuar"
            # -------------------------------------------------------------------
            # Si detectamos que el usuario tiene dudas/preguntas, respondemos sin avanzar de campo.
            dudas_triggers = ["duda", "pregunta", "?", "por qu√©", "porque", "no entiendo", "ayuda", "para qu√©", "para que", "por que", "como puedo", "como"]
            if any(trigger in user_message for trigger in dudas_triggers):
                # Llamamos al LLM con un prompt que explique el campo y pregunte si desea continuar
                explanation_prompt = f"""
                {SYSTEM_PROMPT}

                ### Contexto:
                El usuario est√° llenando un **formato de denuncia** y tiene dudas o quiere m√°s informaci√≥n 
                sobre el siguiente dato: **{dato_actual}**.
                Expl√≠cale por qu√© es importante, dale ejemplos si aplica. 
                Luego, termina la respuesta con una frase para saber si quiere 
                'continuar' o si tiene m√°s dudas, por ejemplo:
                "¬øTienes m√°s dudas o deseas continuar con la denuncia?"
                
                üì© Pregunta del usuario: "{user_message}"
                """

                messages = session["messages"]
                messages.append({"role": "user", "content": user_message})

                completion_exp = client.chat.completions.create(
                    model="gpt-4-turbo",
                    messages=[{"role": "system", "content": explanation_prompt}] + messages,
                    max_tokens=500
                )
                explanation_response = (completion_exp.choices[0].message.content 
                                        if completion_exp.choices else "No se pudo obtener una respuesta clara.")

                # Actualizamos 'messages'
                session["messages"] = messages

                # Devolvemos la explicaci√≥n; seguimos en el MISMO dato
                return jsonify({"response": explanation_response})

            # Si el usuario dice "continuar", interpretamos que ya no tiene m√°s dudas 
            # y quiere dar el dato. Le pedimos que ingrese el valor (o lo revalidamos).
            continuar_triggers = ["continuar", "avanzar", "seguir", "ok", "listo", "entiendo", "comprendo", "ya entend√≠", "ya entendi"]
            if any(trigger in user_message for trigger in continuar_triggers):
                # Obtener el campo actual (o el siguiente campo, seg√∫n tu l√≥gica)
                if "datos_faltantes" in session and session["datos_faltantes"]:
                    siguiente_dato = session["datos_faltantes"][0]
                    # Simplemente le dices al usuario: "ok, continuemos con ... "
                    return jsonify({
                        "response": markdown.markdown(
                            f"Perfecto, continuemos con la denuncia. "
                            f"El siguiente dato que necesito es **{siguiente_dato}**. "
                            "Por favor, ingr√©salo, o escribe 'omitir' si no deseas proporcionarlo, "
                            "o 'cancelar' para detener el proceso."
                        ),
                        "audio_response": audio_response_path
                    })
                else:
                    return jsonify({
                        "response": (
                            "No hay m√°s datos pendientes. Parece que la denuncia est√° casi completa. "
                            "Si deseas revisarla o generar el PDF, av√≠same."
                        ),
                        "audio_response": audio_response_path
                    })
                    
            # --------------------------------
            #  1) MEDIDAS CAUTELARES
            # --------------------------------
            if dato_actual == "medidas_cautelares":
                # Si no existe la lista en datos_usuario, se crea
                if "medidas_cautelares_lista" not in datos_usuario:
                    datos_usuario["medidas_cautelares_lista"] = []

                # Siempre mostrar la lista de opciones antes de esperar la respuesta del usuario
                opciones_str = "\n".join(f"{i+1}. {op}" for i, op in enumerate(MEDIDAS_CAUTELARES_OPCIONES))
                
                # Si el usuario no ha ingresado nada a√∫n, se le muestran las opciones
                if not session.get("pidiendo_medidas_cautelares", False):
                    session["pidiendo_medidas_cautelares"] = True
                    texto = f"Estas son las medidas cautelares disponibles: {opciones_str}. Para seleccionar, escribe los n√∫meros separados por comas (ej: '1,3'). Escribe 'otra' para agregar una medida no listada. Cuando termines, escribe 'terminar'."                    
                    audio_response_path = text_to_speech(texto)
                    return jsonify({
                        "response": (
                            "Estas son las medidas cautelares disponibles:\n\n"
                            f"{opciones_str}\n\n"
                            "Para seleccionar, escribe los n√∫meros separados por comas (ej: '1,3'). "
                            "Escribe 'otra' para agregar una medida no listada. "
                            "Cuando termines, escribe 'terminar'."
                        ),
                        "audio_response": audio_response_path
                    })
                # Manejo de 'terminar' para medidas cautelares
                if user_message == "terminar":
                    # Verificar si se han seleccionado medidas cautelares
                    if not datos_usuario.get("medidas_cautelares_lista"):
                        datos_usuario["medidas_cautelares"] = "_________________________"
                    else:
                        texto_medidas = "\n".join(f"- {m}" for m in datos_usuario["medidas_cautelares_lista"])
                        datos_usuario["medidas_cautelares"] = texto_medidas

                    # Guardar en sesi√≥n antes de continuar
                    session["datos_usuario"] = datos_usuario

                    # Remover 'pidiendo_medidas_cautelares' de la sesi√≥n
                    session.pop("pidiendo_medidas_cautelares", None)

                    # Avanzar al siguiente dato
                    if session.get("datos_faltantes"):
                        session["datos_faltantes"] = session["datos_faltantes"][1:]
                    
                    # Verificar si a√∫n hay datos faltantes
                    if session["datos_faltantes"]:
                        siguiente_dato = session["datos_faltantes"][0]

                        # Definir opciones de medidas de protecci√≥n
                        opciones_str = "\n".join(f"{i+1}. {op}" for i, op in enumerate(MEDIDAS_PROTECCION_OPCIONES))

                        # Ahora activar la petici√≥n de medidas de protecci√≥n
                        session["pidiendo_medidas_proteccion"] = True  # <--- NUEVA VARIABLE PARA CONTROLAR EL FLUJO
                        texto = f"Se han registrado tus medidas cautelares. Ahora, selecciona las **medidas de protecci√≥n** que solicitas para proteger tus derechos. Estas son las medidas de protecci√≥n disponibles: {opciones_str}. Para seleccionar, escribe los n√∫meros separados por comas (ej: '1,3'). Escribe 'otra' para agregar una medida no listada. Cuando termines, escribe 'terminar'."                    
                        audio_response_path = text_to_speech(texto)
                        return jsonify({
                            "response": markdown.markdown(
                                "‚úÖ Se han registrado tus medidas cautelares.\n\n"
                                "Ahora, selecciona las **medidas de protecci√≥n** que solicitas para proteger tus derechos.\n\n"
                                "Estas son las medidas de protecci√≥n disponibles:\n\n"
                                f"{opciones_str}\n\n"
                                "Para seleccionar, escribe los n√∫meros separados por comas (ej: '1,3'). "
                                "Escribe 'otra' para agregar una medida no listada. "
                                "Cuando termines, escribe 'terminar'."
                            ),
                            "audio_response": audio_response_path
                        })

                    else:
                        # No hay m√°s campos, generar la denuncia
                        try:
                            resultado = procesar_denuncia(datos_usuario)
                            if isinstance(resultado, dict) and "error" in resultado:
                                session["datos_faltantes"] = resultado["faltantes"]
                                return jsonify({
                                    "response": (f"‚ö†Ô∏è Faltan datos: {', '.join(resultado['faltantes'])}. "
                                                "Por favor, ingr√©salos para continuar."),
                                    "audio_response": audio_response_path
                                })
                            session["pdf_path"] = resultado
                            session.pop("datos_faltantes", None)
                            session.pop("datos_usuario", None)
                            texto = "La denuncia ha sido generada correctamente. Puedes descargarla en el link que te genere. Este es un formato de denuncia con los datos proporcionados. Puedes revisarlo y editarlo si lo deseas. ¬°Estoy aqu√≠ para ayudarte!"
                            audio_response_path = text_to_speech(texto)
                            return jsonify({
                                "response": (
                                    "‚úÖ La denuncia ha sido generada correctamente. "
                                    "Puedes descargarla aqu√≠: /download_sue\n\n"
                                    "Este es un formato de denuncia con los datos proporcionados. "
                                    "Puedes revisarlo y editarlo si lo deseas. "
                                    "¬°Estoy aqu√≠ para ayudarte! üòä"
                                ),
                                "audio_response": audio_response_path
                            })
                        except Exception as e:
                            return jsonify({"response": f"‚ùå Error al generar la denuncia: {str(e)}"}), 500

                # Manejo de 'otra'
                if user_message == "otra":
                    texto = "Escribe la medida cautelar adicional que deseas. Cuando termines, escribe 'terminar'."
                    audio_response_path = text_to_speech(texto)
                    return jsonify({
                        "response": (
                            "Escribe la medida cautelar adicional que deseas. "
                            "Cuando termines, escribe 'terminar'."
                        ),
                        "audio_response": audio_response_path
                    })

                # Interpretar la selecci√≥n
                selecciones = [s.strip() for s in user_message.split(",")]
                added_something = False

                for sel in selecciones:
                    if sel.isdigit():
                        idx = int(sel) - 1
                        if 0 <= idx < len(MEDIDAS_CAUTELARES_OPCIONES):
                            datos_usuario["medidas_cautelares_lista"].append(MEDIDAS_CAUTELARES_OPCIONES[idx])
                            added_something = True
                    else:
                        # Agregar medidas personalizadas
                        if sel:
                            datos_usuario["medidas_cautelares_lista"].append(sel)
                            added_something = True

                session["datos_usuario"] = datos_usuario
                texto = "Medidas cautelares seleccionadas:\n" + "\n".join(f"- {m}" for m in datos_usuario["medidas_cautelares_lista"]) + "\n\nEscribe m√°s n√∫meros, 'otra' para a√±adir otra, o 'terminar' si has terminado con las medidas cautelares."
                audio_response_path = text_to_speech(texto)
                return jsonify({
                    "response": (
                        "Medidas cautelares seleccionadas:\n"
                        + "\n".join(f"- {m}" for m in datos_usuario["medidas_cautelares_lista"])
                        + "\n\nEscribe m√°s n√∫meros, 'otra' para a√±adir otra, "
                        "o 'terminar' si has terminado con las medidas cautelares."
                    ),
                    "audio_response": audio_response_path
                })

            # --------------------------------
            #  2) MEDIDAS DE PROTECCI√ìN
            # --------------------------------
            if dato_actual == "medidas_proteccion":
                # Si no existe la lista en datos_usuario, se crea
                if "medidas_proteccion_lista" not in datos_usuario:
                    datos_usuario["medidas_proteccion_lista"] = []

                # Siempre mostrar la lista de opciones antes de esperar la respuesta del usuario
                opciones_str = "\n".join(f"{i+1}. {op}" for i, op in enumerate(MEDIDAS_PROTECCION_OPCIONES))

                if not session.get("pidiendo_medidas_proteccion", False):
                    session["pidiendo_medidas_proteccion"] = True
                    texto = f"Estas son las medidas de protecci√≥n disponibles: {opciones_str}.Para seleccionar, escribe los n√∫meros separados por comas (ej: '1,3').Escribe 'otra' para agregar una medida no listada. Cuando termines, escribe 'terminar'."
                    audio_response_path = text_to_speech(texto)
                    return jsonify({
                        "response": (
                            "Estas son las medidas de protecci√≥n disponibles:\n\n"
                            f"{opciones_str}\n\n"
                            "Para seleccionar, escribe los n√∫meros separados por comas (ej: '1,3'). "
                            "Escribe 'otra' para agregar una medida no listada. "
                            "Cuando termines, escribe 'terminar'."
                        ),
                        "audio_response": audio_response_path
                    })

                # Manejo de 'terminar' para medidas de protecci√≥n
                if user_message == "terminar":
                    # Verificar si se han seleccionado medidas de protecci√≥n
                    if not datos_usuario.get("medidas_proteccion_lista"):
                        datos_usuario["medidas_proteccion"] = "_________________________"
                    else:
                        texto_protecciones = "\n".join(f"- {m}" for m in datos_usuario["medidas_proteccion_lista"])
                        datos_usuario["medidas_proteccion"] = texto_protecciones

                    # Guardar en sesi√≥n antes de continuar
                    session["datos_usuario"] = datos_usuario

                    # Remover 'pidiendo_medidas_proteccion' de la sesi√≥n
                    session.pop("pidiendo_medidas_proteccion", None)

                    # Avanzar al siguiente dato si hay m√°s pendientes
                    if session.get("datos_faltantes"):
                        session["datos_faltantes"] = session["datos_faltantes"][1:]

                    # Verificar si a√∫n hay datos faltantes
                    if session["datos_faltantes"]:
                        siguiente_dato = session["datos_faltantes"][0]
                        texto = f"‚úÖ Se han registrado tus medidas de protecci√≥n.Ahora necesito **{siguiente_dato}**.¬øQu√© tipo de prueba deseas ofrecer? Elige una opci√≥n: 1Ô∏è.Confesional,2Ô∏è.Testimonial,3Ô∏è.Documental P√∫blica o Privada,4Ô∏è.Presuncional Legal y Humana,5Ô∏è.Instrumental de Actuaciones,Escribe el n√∫mero de la opci√≥n que deseas elegir, o escribe 'omitir' si no deseas proporcionarlo, o 'cancelar' para salir."
                        audio_response_path = text_to_speech(texto)
                        return jsonify({
                            "response": (
                                "‚úÖ Se han registrado tus medidas de protecci√≥n.\n\n"
                                f"Ahora necesito **{siguiente_dato}**.\n\n"
                                "¬øQu√© tipo de prueba deseas ofrecer? Elige una opci√≥n:\n"
                                "1Ô∏è‚É£ Confesional\n"
                                "2Ô∏è‚É£ Testimonial\n"
                                "3Ô∏è‚É£ Documental P√∫blica o Privada\n"
                                "4Ô∏è‚É£ Presuncional Legal y Humana\n"
                                "5Ô∏è‚É£ Instrumental de Actuaciones\n\n"
                                "Escribe el n√∫mero de la opci√≥n que deseas elegir, "
                                "o escribe 'omitir' si no deseas proporcionarlo, o 'cancelar' para salir."
                            ),
                            "audio_response": audio_response_path
                        })
                    else:
                        # Generar denuncia
                        try:
                            resultado = procesar_denuncia(datos_usuario)
                            if isinstance(resultado, dict) and "error" in resultado:
                                session["datos_faltantes"] = resultado["faltantes"]
                                return jsonify({
                                    "response": (f"‚ö†Ô∏è Faltan datos: {', '.join(resultado['faltantes'])}. "
                                                "Por favor, ingr√©salos para continuar."),
                                    "audio_response": audio_response_path
                                })
                            session["pdf_path"] = resultado
                            session.pop("datos_faltantes", None)
                            session.pop("datos_usuario", None)
                            texto = "La denuncia ha sido generada correctamente. Puedes descargarla en el link que te genere. Este es un formato de denuncia con los datos proporcionados. Puedes revisarlo y editarlo si lo deseas. ¬°Estoy aqu√≠ para ayudarte!"
                            audio_response_path = text_to_speech(texto)
                            return jsonify({
                                "response": (
                                    "‚úÖ La denuncia ha sido generada correctamente. "
                                    "Puedes descargarla aqu√≠: /download_sue\n\n"
                                    "Este es un formato de denuncia con los datos proporcionados. "
                                    "Puedes revisarlo y editarlo si lo deseas. "
                                    "¬°Estoy aqu√≠ para ayudarte! üòä"
                                ),
                                "audio_response": audio_response_path
                            })
                        except Exception as e:
                            return jsonify({"response": f"‚ùå Error al generar la denuncia: {str(e)}"}), 500

                # Manejo de 'otra'
                if user_message == "otra":
                    texto = "Escribe la medida de protecci√≥n adicional que deseas. Cuando termines, escribe 'terminar'."
                    audio_response_path = text_to_speech(texto)
                    return jsonify({
                        "response": (
                            "Escribe la medida de protecci√≥n adicional que deseas. "
                            "Cuando termines, escribe 'terminar'."
                        ),
                        "audio_response": audio_response_path
                    })

                # Interpretar la selecci√≥n
                selecciones = [s.strip() for s in user_message.split(",")]
                added_something = False

                for sel in selecciones:
                    if sel.isdigit():
                        idx = int(sel) - 1
                        if 0 <= idx < len(MEDIDAS_PROTECCION_OPCIONES):
                            datos_usuario["medidas_proteccion_lista"].append(MEDIDAS_PROTECCION_OPCIONES[idx])
                            added_something = True
                    else:
                        # Agregar medidas personalizadas
                        if sel:
                            datos_usuario["medidas_proteccion_lista"].append(sel)
                            added_something = True

                session["datos_usuario"] = datos_usuario
                texto = "Medidas de protecci√≥n seleccionadas:" + "\n".join(f"- {m}" for m in datos_usuario["medidas_proteccion_lista"]) + "\n\nEscribe m√°s n√∫meros, 'otra' para a√±adir otra, o 'terminar' si has terminado con las medidas de protecci√≥n."
                audio_response_path = text_to_speech(texto)
                return jsonify({
                    "response": (
                        "Medidas de protecci√≥n seleccionadas:\n"
                        + "\n".join(f"- {m}" for m in datos_usuario["medidas_proteccion_lista"])
                        + "\n\nEscribe m√°s n√∫meros, 'otra' para a√±adir otra, "
                        "o 'terminar' si has terminado con las medidas de protecci√≥n."
                    ),
                    "audio_response": audio_response_path
                })
            # --------------------------------
            #  3) PRUEBAS
            # --------------------------------
            if dato_actual == "tipo_prueba":
                if "ha_preguntado_tipo_prueba" not in session:
                    session["ha_preguntado_tipo_prueba"] = True
                    texto = "¬øQu√© tipo de prueba deseas ofrecer? Elige una opci√≥n: 1Ô∏è.Confesional,2Ô∏è.Testimonial, 3Ô∏è.Documental P√∫blica o Privada, 4Ô∏è.Presuncional Legal y Humana, 5Ô∏è.Instrumental de Actuaciones, Escribe el n√∫mero de la opci√≥n que deseas elegir. puedes escribir para omitir o cancelar para terminar el proceso"
                    audio_response_path = text_to_speech(texto)
                    return jsonify({
                        "response": (
                            "¬øQu√© tipo de prueba deseas ofrecer? Elige una opci√≥n:\n"
                            "1Ô∏è‚É£ Confesional\n"
                            "2Ô∏è‚É£ Testimonial\n"
                            "3Ô∏è‚É£ Documental P√∫blica o Privada\n"
                            "4Ô∏è‚É£ Presuncional Legal y Humana\n"
                            "5Ô∏è‚É£ Instrumental de Actuaciones\n"
                            "Escribe el n√∫mero de la opci√≥n que deseas elegir."
                        ),
                        "audio_response": audio_response_path
                    })

                if user_message in ["1", "2", "3", "4", "5"]:
                    tipos_prueba = {
                        "1": "Confesional",
                        "2": "Testimonial",
                        "3": "Documental P√∫blica o Privada",
                        "4": "Presuncional Legal y Humana",
                        "5": "Instrumental de Actuaciones"
                    }
                    
                    datos_usuario["tipo_prueba"] = tipos_prueba[user_message]
                    session["datos_usuario"] = datos_usuario

                    # **üí° IMPORTANTE: Eliminar `tipo_prueba` de `datos_faltantes`**
                    session["datos_faltantes"] = session["datos_faltantes"][1:]

                    if user_message == "1":  # Confesional
                        session["datos_faltantes"].extend([
                            "quien_desahoga", "numero_notarial", "notario_publico_numero", 
                            "donde_funciones_notario", "fecha_intrumento_notarial", 
                            "prueba_confesional", "numeros_prueba"
                        ])
                        return jsonify({
                            "response": "Has seleccionado prueba confesional. ¬øQui√©n desahoga la prueba?",
                            "audio_response": audio_response_path
                        })

                    elif user_message == "2":  # Testimonial
                        session["datos_faltantes"].extend([
                            "quien_desahoga", "numero_notarial", "notario_publico_numero", 
                            "donde_funciones_notario", "fecha_intrumento_notarial", 
                            "prueba_testimonial", "numeros_prueba"
                        ])
                        return jsonify({
                            "response": "Has seleccionado prueba testimonial. ¬øQui√©n desahoga la prueba?",
                            "audio_response": audio_response_path
                        })

                    elif user_message == "3":  # Documental P√∫blica o Privada
                        session["datos_faltantes"].extend([
                            "documentos_oficiales", "folio", "fecha_folio", 
                            "autoridad_emite", "acto_documento", "documento_prueba", "numeros_prueba"
                        ])
                        return jsonify({
                            "response": "Has seleccionado prueba documental. ¬øCu√°l es el documento oficial que presentas?",
                            "audio_response": audio_response_path
                        })

                    elif user_message in ["4", "5"]:  # Presuncional Legal y Humana o Instrumental de Actuaciones
                        if user_message == "4":
                            datos_usuario["tipo_prueba"] = "presuncional"
                        else:
                            datos_usuario["tipo_prueba"] = "instrumental"

                        # **Eliminamos los datos dependientes que no aplican**
                        datos_omitidos = [
                            "quien_desahoga", "numero_notarial", "notario_publico_numero",
                            "donde_funciones_notario", "fecha_intrumento_notarial",
                            "prueba_confesional", "prueba_testimonial", "documento_prueba",
                            "numeros_prueba","folio","fecha_folio", "documentos_oficiales"
                        ]

                        session["datos_faltantes"] = [dato for dato in session.get("datos_faltantes", []) if dato not in datos_omitidos]

                        session["datos_usuario"] = datos_usuario

                        # **üí° IMPORTANTE: Avanzar al siguiente campo**
                        if session["datos_faltantes"]:
                            siguiente_dato = session["datos_faltantes"][0]
                            texto = f"‚úÖ Se ha registrado tu prueba {datos_usuario['tipo_prueba']}. Ahora necesito **{siguiente_dato}**."
                            audio_response_path = text_to_speech(texto)
                            return jsonify({
                                "response": markdown.markdown(f"‚úÖ Se ha registrado tu prueba {datos_usuario['tipo_prueba']}. Ahora necesito **{siguiente_dato}**."),
                                "audio_response": audio_response_path
                            })
                        else:
                            resultado = procesar_denuncia(datos_usuario)
                            if isinstance(resultado, dict) and "error" in resultado:
                                session["datos_faltantes"] = resultado["faltantes"]
                                return jsonify({
                                    "response": f"‚ö†Ô∏è Faltan datos: {', '.join(resultado['faltantes'])}. Por favor, ingr√©salos para continuar.",
                                })
                            session["pdf_path"] = resultado
                            session.pop("datos_faltantes", None)
                            session.pop("datos_usuario", None)
                            texto = "La denuncia ha sido generada correctamente. Puedes descargarla en el link que te genere. Este es un formato de denuncia con los datos proporcionados. Puedes revisarlo y editarlo si lo deseas. ¬°Estoy aqu√≠ para ayudarte!"
                            audio_response_path = text_to_speech(texto)
                            return jsonify({
                                "response": "‚úÖ La denuncia ha sido generada correctamente. Puedes descargarla aqu√≠: /download_sue",
                                "audio_response": audio_response_path
                            })

                return jsonify({
                    "response": "Por favor, selecciona una opci√≥n v√°lida (1-5) para el tipo de prueba."
                })

    
            if dato_actual == "narraciones":
                if "narraciones" not in datos_usuario:
                    datos_usuario["narraciones"] = []

                if not session.get("ejemplo_narraciones_mostrado", False):
                    session["ejemplo_narraciones_mostrado"] = True
                    ejemplo_narracion = (
                        "Ejemplo de narraci√≥n de hechos:\n\n"
                        "El cinco de febrero de dos mil diecisiete, estando presentes en la oficina de XXX, "
                        "ubicada en las calles de XXX, el denunciado me agredi√≥ verbalmente al se√±alar que "
                        "no deb√≠a participar como candidata al cargo de XXXX, indicando expresamente: "
                        "‚Äúustedes las mujeres no sirven para esto de la pol√≠tica, no tienen que salir de su casa "
                        "y deben quedarse en la cocina‚Äù.\n\n"
                        "Con estas expresiones, se vulneran derechos como la participaci√≥n pol√≠tica, "
                        "la no discriminaci√≥n y la vida libre de violencia.\n\n"
                        "Por favor, ingresa tu primer relato de hechos ahora. O escribe 'omitir' si no deseas narrarlo, "
                        "o 'cancelar' para salir."
                    )
                    return jsonify({"response": ejemplo_narracion})

                if user_message.lower() in ["agregar", "otro"]:
                    return jsonify({"response": "Describe el siguiente hecho. Cuando termines, escribe 'terminar' o 'agregar' si quieres m√°s."})

                if user_message.lower() == "terminar":
                    session.pop("ejemplo_narraciones_mostrado", None)
                    texto_final = "\n\n".join(datos_usuario["narraciones"])
                    datos_usuario["narraciones"] = texto_final
                    session["datos_usuario"] = datos_usuario
                    session["datos_faltantes"] = datos_faltantes[1:]
                    
                    if session["datos_faltantes"]:
                        siguiente_dato = session["datos_faltantes"][0]
                        desc = field_info.get(dato_actual, {}).get("descripcion", "Informaci√≥n no disponible.")
                        ejemp = field_info.get(dato_actual, {}).get("ejemplo", "Ejemplo no disponible.")
                        texto = f"Se han registrado tus narraciones. Ahora necesitamos **{siguiente_dato}**, {desc}. un ejemplo de como llenarlo seria: {ejemp}. ¬øPodr√≠as proporcionarlo ahora?. Si no deseas darlo, escribe 'omitir', o 'cancelar'."
                        audio_response_path = text_to_speech(texto)
                        return jsonify({
                            "response": markdown.markdown(
                                "‚úÖ Se han registrado tus narraciones.\n\n"
                                f"Ahora necesitamos **{siguiente_dato}**, {desc}.\n\n"
                                f"{ejemp}\n\n"
                                "¬øPodr√≠as proporcionarlo ahora? "
                                "Si no deseas darlo, escribe 'omitir', o 'cancelar'."
                            ),
                            "audio_response": audio_response_path
                        })
                    else:
                        # Generar denuncia
                        try:
                            resultado = procesar_denuncia(datos_usuario)
                            if isinstance(resultado, dict) and "error" in resultado:
                                session["datos_faltantes"] = resultado["faltantes"]
                                return jsonify({
                                    "response":markdown.markdown(f"‚ö†Ô∏è Faltan datos: {', '.join(resultado['faltantes'])}. "
                                                 "Por favor, ingr√©salos para continuar.")
                                })
                            session["pdf_path"] = resultado
                            session.pop("datos_faltantes", None)
                            session.pop("datos_usuario", None)
                            texto = "La denuncia ha sido generada correctamente. Puedes descargarla en el link que te genere. Este es un formato de denuncia con los datos proporcionados. Puedes revisarlo y editarlo si lo deseas. ¬°Estoy aqu√≠ para ayudarte!"
                            audio_response_path = text_to_speech(texto)
                            return jsonify({
                                "response": markdown.markdown(
                                    "‚úÖ La denuncia ha sido generada correctamente. "
                                    "Puedes descargarla aqu√≠: /download_sue\n\n"
                                    "Este es un formato de denuncia con los datos que me proporcionaste. "
                                    "Si deseas, puedes revisarlo y editarlo si lo consideras necesario. "
                                    "¬°Estoy para ayudarte! üòä"
                                ),
                                "audio_response": audio_response_path
                            })
                        except Exception as e:
                            return jsonify({
                                "response": f"‚ùå Error al generar la denuncia: {str(e)}"
                            }), 500

                if not es_narracion_valida(user_message):
                    return jsonify({"response": "‚ö†Ô∏è Tu narraci√≥n parece muy corta o inv√°lida..."})

                # Nuevo prompt modificado
                narraciones_prompt = f"""
                Eres un validador de narrativas de violencia pol√≠tica. Eval√∫a si el texto cumple:
                1. Fecha concreta (ej: 5 de febrero de 2023)
                2. Lugar identificable (ej: oficina de X en calle Y)
                3. Cita textual o descripci√≥n espec√≠fica de los hechos
                4. Menciona al menos un derecho vulnerado

                Texto a validar: "{user_message}"

                Responde SOLO con:
                - "se ha registrado narraciones" si cumple TODOS los requisitos
                - Explicaci√≥n de faltas y ejemplo de mejora si no cumple
                """

                completion_llm = client.chat.completions.create(
                    model="gpt-4-turbo",
                    messages=[{"role": "system", "content": narraciones_prompt}],
                    temperature=0  # Para mayor precisi√≥n
                )
                
                bot_ans = completion_llm.choices[0].message.content if completion_llm.choices else ""
                clean_ans = bot_ans.replace("*", "").replace("‚úÖ", "").strip().lower()

                if "se ha registrado narraciones" in clean_ans:
                    datos_usuario["narraciones"].append(user_message.strip())
                    session["datos_usuario"] = datos_usuario
                    texto = "Narraci√≥n agregada. ¬øDeseas **agregar** otro hecho o **terminar**?"
                    audio_response_path = text_to_speech(texto)
                    return jsonify({
                        "response": markdown.markdown(
                            "‚úÖ Narraci√≥n agregada.\n\n"
                            "¬øDeseas **agregar** otro hecho o **terminar**?"
                        ),
                        "audio_response": audio_response_path
                    })
                else:
                    return jsonify({"response": bot_ans})
            # -------------------------------------------------------------------
            # 2) Validaci√≥n del dato ingresado con el LLM (c√≥digo existente)
            # -------------------------------------------------------------------
            validation_func = VALIDATION_RULES.get(dato_actual)
            if validation_func:
                if not validation_func(user_message):
                    # ‚ùå Valor claramente inv√°lido
                    return jsonify({
                        "response": markdown.markdown(
                            f"‚ö†Ô∏è El valor **{user_message}** no es v√°lido para **{dato_actual}** "
                            f"seg√∫n las reglas m√≠nimas. Int√©ntalo de nuevo, "
                            "escribe 'omitir' para dejarlo vac√≠o, o 'cancelar' para salir."
                        ),
                        "audio_response": audio_response_path
                    })
            desc = field_info.get(dato_actual, {}).get("descripcion", "Informaci√≥n no disponible.")
            ejemp = field_info.get(dato_actual, {}).get("ejemplo", "Ejemplo no disponible.")
            full_prompt = f"""
            {SYSTEM_PROMPT}
            ### Instrucciones para el LLM:
            1. El usuario est√° llenando un **formato de denuncia** y debe ingresar el siguiente dato: **{dato_actual}**.
            2. Aplica las reglas de validaci√≥n de abajo (seg√∫n el campo).  
            - **Si** el dato es v√°lido, responde con la frase exacta: "**se ha registrado {dato_actual}**".
            - **Si** es inv√°lido:
                - Explica por qu√© no es v√°lido (formato, longitud, etc.).
                - Da un ejemplo correcto.
                - P√≠dele que lo ingrese de nuevo (no usar la frase "se ha registrado").
                - **No** avances al siguiente campo.
            3. Si el usuario escribe "omitir", deja este dato en blanco y pasa al siguiente.
            4. Si el usuario escribe "cancelar", se cancela el proceso.
            5. No avances ni confirmes el dato hasta que sea realmente v√°lido.

            ### Reglas de validaci√≥n (ejemplo):
            - **nombre_completo**  
            - Al menos 2 palabras (ej.: "Mar√≠a P√©rez").  
            - No puede ser solo n√∫meros ni un nombre incompleto.  
            - **telefono**  
            - Solo d√≠gitos (0-9).  
            - Longitud m√≠nima 7 (ej.: "5523456789").  
            - **correo**  
            - Debe contener '@' y un dominio (ej.: "ejemplo@dominio.com").  
            ##
            ### Contexto:
            - **Dato solicitado:** {dato_actual}
            - **Valor ingresado por el usuario:** "{user_message}"

            Explica por qu√© este dato es importante en el proceso de denuncia.  
            Si el usuario pide omitir o cancelar, respeta esa decisi√≥n.  

            """


            messages = session["messages"]
            messages.append({"role": "user", "content": user_message})

            completion = client.chat.completions.create(
                model="gpt-4-turbo",
                messages=[{"role": "system", "content": full_prompt}] + messages,
                max_tokens=500
            )
            bot_response = (completion.choices[0].message.content
                            if completion.choices else "No se pudo obtener una respuesta clara.")

            # Persistimos la conversaci√≥n
            session["messages"] = messages

            # ¬øel LLM confirma que el dato es v√°lido?
            if any(frase in bot_response.lower() for frase in [
                "dato registrado", "se ha registrado", "ha sido guardado",
                "v√°lido", "correcto", "registrado"]):   
                datos_usuario[dato_actual] = user_message.strip()
                session["datos_usuario"] = datos_usuario
                session["datos_faltantes"] = datos_faltantes[1:]

                if session["datos_faltantes"]:
                    siguiente_dato = session["datos_faltantes"][0]
                    desc = field_info.get(siguiente_dato, {}).get("descripcion", "Informaci√≥n no disponible.")
                    ejemp = field_info.get(siguiente_dato, {}).get("ejemplo", "Ejemplo no disponible.")
                    texto = f"se ha registrado **{dato_actual}**. El siguiente dato es **{siguiente_dato}**, que sirve {desc}. {ejemp},¬øPodr√≠as proporcionarlo?"
                    audio_response_path = text_to_speech(texto)
                    return jsonify({
                        "response": markdown.markdown(
                            f"‚úÖ Se ha registrado **{dato_actual}**.\n\n"
                            f"El siguiente dato es **{siguiente_dato}**, "
                            f"que sirve {desc}.\n\n"
                            f"{ejemp}\n\n"
                            "¬øPodr√≠as proporcionarlo?"
                        ),
                        "audio_response": audio_response_path
                    })
                else:
                    # Generar denuncia
                    try:
                        resultado = procesar_denuncia(datos_usuario)
                        
                        if isinstance(resultado, dict) and "error" in resultado:
                            session["datos_faltantes"] = resultado["faltantes"]
                            texto = f"‚ö†Ô∏è Faltan datos: {', '.join(resultado['faltantes'])}. Por favor, ingr√©salos para continuar."
                            audio_response_path = text_to_speech(texto)
                            return jsonify({
                                "response": (f"‚ö†Ô∏è Faltan datos: {', '.join(resultado['faltantes'])}. "
                                             "Por favor, ingr√©salos para continuar."),
                                "audio_response": audio_response_path
                            })

                        session["pdf_path"] = resultado
                        session.pop("datos_faltantes", None)
                        session.pop("datos_usuario", None)
                        texto = "La denuncia ha sido generada correctamente. Puedes descargarla en el link que te genere. Este es un formato de denuncia con los datos proporcionados. Puedes revisarlo y editarlo si lo deseas. ¬°Estoy aqu√≠ para ayudarte!"
                        audio_response_path = text_to_speech(texto)
                        return jsonify({
                            "response": (
                                "‚úÖ La denuncia ha sido generada correctamente. "
                                "Puedes descargarla aqu√≠: /download_sue\n\n"
                                "Este es un formato de denuncia con los datos proporcionados. "
                                "Puedes revisarlo y editarlo si lo deseas. "
                                "¬°Estoy aqu√≠ para ayudarte! üòä"
                            ),
                            "audio_response": audio_response_path
                        })
                    except Exception as e:
                        return jsonify({
                            "response": f"‚ùå Error al generar la denuncia: {str(e)}"
                        }), 500

            # Si el LLM no confirma, devolvemos la respuesta para que el usuario corrija
            return jsonify({"response": bot_response})

        # -----------------------------------------------------------------------
        # 2) Si NO se est√° llenando datos, revisamos si el usuario quiere iniciar denuncia
        # -----------------------------------------------------------------------
        frases_activadoras = [
            "quiero hacer una denuncia",
            "necesito denunciar",
            "quiero denunciar"
        ]
        user_message_clean = re.sub(r"[^\w\s]", "", user_message.lower()).strip()
        if user_message_clean in frases_activadoras:
            session["awaiting_decision"] = True
            texto = "üîç ¬øQu√© deseas hacer?. 1Ô∏è.**üìÑ Iniciar el proceso de denuncia.**,2Ô∏è.**üß† Recibir orientaci√≥n antes de denunciar.** Escribe '1' para iniciar la denuncia o '2' para orientaci√≥n."
            audio_response_path = text_to_speech(texto)
            return jsonify({
                "response": markdown.markdown(
                    "üîç ¬øQu√© deseas hacer?\n\n"
                    "1Ô∏è‚É£ **üìÑ Iniciar el proceso de denuncia.**\n"
                    "2Ô∏è‚É£ **üß† Recibir orientaci√≥n antes de denunciar.**\n\n"
                    "Escribe '1' para iniciar la denuncia o '2' para orientaci√≥n."
                ),
                "audio_response": audio_response_path
            })

        # 2.1) Manejo de la decisi√≥n
        if session.get("awaiting_decision"):
            if user_message in respuestas_proceder or user_message == "1":
                session.pop("awaiting_decision", None)
                # Aqu√≠ definimos la lista COMPLETA de campos faltantes
                session["datos_faltantes"] = LISTA_CAMPOS_DENUNCIA.copy()
                session["datos_usuario"] = {}

                primer_dato = session["datos_faltantes"][0]
                texto = f"Perfecto, iniciaremos la denuncia. A continuaci√≥n te mostrar√© la lista de datos que necesitaremos y por qu√© son importantes: 1.Nombre completo: Para identificar formalmente a la persona que presenta la denuncia. 2.Tel√©fono Un medio de contacto para resolver dudas o enviar notificaciones. 3.Domicilio: Tu direcci√≥n oficial, necesaria en algunos tr√°mites legales. 4.Correo Para env√≠o de notificaciones y seguimiento digital. 5.Personas autorizadas: Si deseas que alguien m√°s reciba notificaciones o te ayude en el proceso. 6.Fecha de los hechos: El d√≠a en que ocurrieron los hechos que denuncias. 7.Lugar de los hechos: D√≥nde sucedieron esos hechos. 8.Ciudad: Ubicaci√≥n general para contextualizar lo ocurrido. 9.Persona denunciada: Nombre completo de la persona a quien diriges la denuncia. 10.Relaci√≥n con la persona denunciada: Si es familiar, colega, etc. 11.Narraci√≥n de los hechos: Descripci√≥n detallada de lo que ocurri√≥. 12.Afectaci√≥n: C√≥mo te impactaron estos hechos. 13.Medidas cautelares: Acciones urgentes que solicitas para proteger tus derechos. 14.Protecci√≥n: Medidas adicionales de protecci√≥n que consideras necesarias.15.Pruebas: Testimonios, documentos u otras evidencias que respalden la denuncia. Te ir√© solicitando estos datos uno por uno. Puedes omitir un dato si no lo deseas proporcionar, o escribir cancelar para detener el proceso en cualquier momento. Para comenzar, por favor, ind√≠came {primer_dato}."
                audio_response_path = text_to_speech(texto)
                respuesta = (
                        "Perfecto, iniciaremos la denuncia. A continuaci√≥n te mostrar√© la lista "
                        "de datos que necesitaremos y por qu√© son importantes:\n"
                        
                        "1. **Nombre completo**: Para identificar formalmente a la persona que presenta la denuncia.\n"
                        "2. **Tel√©fono**: Un medio de contacto para resolver dudas o enviar notificaciones.\n"
                        "3. **Domicilio**: Tu direcci√≥n oficial, necesaria en algunos tr√°mites legales.\n"
                        "4. **Correo**: Para env√≠o de notificaciones y seguimiento digital.\n"
                        "5. **Personas autorizadas**: Si deseas que alguien m√°s reciba notificaciones o te ayude en el proceso.\n"
                        "6. **Fecha de los hechos**: El d√≠a en que ocurrieron los hechos que denuncias.\n"
                        "7. **Lugar de los hechos**: D√≥nde sucedieron esos hechos.\n"
                        "8. **Ciudad**: Ubicaci√≥n general para contextualizar lo ocurrido.\n"
                        "9. **Persona denunciada**: Nombre completo de la persona a quien diriges la denuncia.\n"
                        "10. **Relaci√≥n con la persona denunciada**: Si es familiar, colega, etc.\n"
                        "11. **Narraci√≥n de los hechos**: Descripci√≥n detallada de lo que ocurri√≥.\n"
                        "12. **Afectaci√≥n**: C√≥mo te impactaron estos hechos.\n"
                        "13. **Medidas cautelares**: Acciones urgentes que solicitas para proteger tus derechos.\n"
                        "14. **Protecci√≥n**: Medidas adicionales de protecci√≥n que consideras necesarias.\n"
                        "15. **Pruebas**: Testimonios, documentos u otras evidencias que respalden la denuncia.\n"

                        "Te ir√© solicitando estos datos uno por uno. Puedes **omitir** un dato si no "
                        "lo deseas proporcionar, o escribir **cancelar** para detener el proceso en cualquier momento.\n"
                        
                        f"Para comenzar, por favor, ind√≠came **{primer_dato}**."
                    )
                respuesta_html = markdown.markdown(respuesta)
                return jsonify({
                    "response": respuesta_html,
                    "audio_response": audio_response_path
                })

            elif user_message in respuestas_no or user_message == "2":
                # El usuario quiere orientaci√≥n antes de denunciar
                session["awaiting_orientation_response"] = True
                session.pop("awaiting_decision", None)

                messages = session["messages"]
                messages.append({"role": "user", "content": "¬øC√≥mo puedo presentar una denuncia?"})

                completion = client.chat.completions.create(
                    model="gpt-4-turbo",
                    messages=[{"role": "system", "content": SYSTEM_PROMPT}] + messages,
                    max_tokens=500
                )

                bot_response = (completion.choices[0].message.content
                                if completion.choices else "No se pudo obtener una respuesta clara.")

                # Persistimos mensajes
                session["messages"] = messages
                texto = bot_response + "\n\nüîπ **¬øTe puedo ayudar en algo m√°s?**"
                audio_response_path = text_to_speech(bot_response)
                
                return jsonify({
                    "response": bot_response + "\n\nüîπ **¬øTe puedo ayudar en algo m√°s?**",
                    "audio_response": audio_response_path
                })

        # -----------------------------------------------------------------------
        # 3) Chat general si no se ha iniciado o no se est√° en proceso de denuncia
        # -----------------------------------------------------------------------
        messages = session["messages"]
        messages.append({"role": "user", "content": user_message})

        completion = client.chat.completions.create(
            model="gpt-4-turbo",
            messages=[{"role": "system", "content": SYSTEM_PROMPT}] + messages,
            max_tokens=500
        )
        bot_response = (completion.choices[0].message.content 
                        if completion.choices else "")

        # Actualizar 'messages'
        session["messages"] = messages

        # Manejo de respuestas vagas
        vague_responses = ["no estoy seguro", "no tengo informaci√≥n", "no puedo responder"]
        if any(vague in bot_response.lower() for vague in vague_responses):
            retrieved_context = search_in_pdfs(user_message)
            if retrieved_context:
                full_prompt = f"""
                {SYSTEM_PROMPT}
                El usuario ha preguntado: "{user_message}"
                No se encontr√≥ una respuesta clara, pero aqu√≠ hay informaci√≥n relevante:
                {retrieved_context}
                Responde de manera clara y √∫til utilizando esta informaci√≥n.
                """
                completion = client.chat.completions.create(
                    model="gpt-4-turbo",
                    messages=[{"role": "system", "content": full_prompt}] + messages,
                    max_tokens=500
                )
                bot_response = (completion.choices[0].message.content 
                                if completion.choices else "No se pudo obtener una respuesta clara.")

        bot_response_html = markdown.markdown(bot_response)
        audio_response_path = text_to_speech(bot_response)
        return jsonify({
            "response": bot_response_html,
            "audio_response": audio_response_path
        })
    except Exception as e:
        return jsonify({"response": f"Error: {str(e)}"}), 500
